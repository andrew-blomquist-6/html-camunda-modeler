!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(e.Saxen={})}(this,function(e){"use strict";var n=String.fromCharCode,t=Object.prototype.hasOwnProperty,r=/&#(\d+);|&#x([0-9a-f]+);|&(\w+);/gi,i={amp:"&",apos:"'",gt:">",lt:"<",quot:'"'};function s(e,r,s,u){return u?t.call(i,u)?i[u]:"&"+u+";":n(r||parseInt(s,16))}function u(e){return e.length>3&&-1!==e.indexOf("&")?e.replace(r,s):e}Object.keys(i).forEach(function(e){i[e.toUpperCase()]=i[e]});var o="http://www.w3.org/2001/XMLSchema-instance",f="xsi",a="xsi:type",c="non-whitespace outside of root node";function l(e){return new Error(e)}function d(e){return"missing namespace for prefix <"+e+">"}function g(e){return{get:e,enumerable:!0}}function b(e){var n,t={};for(n in e)t[n]=e[n];return t}function h(e){return e+"$uri"}function m(){return{line:0,column:0}}function x(e){throw e}e.Parser=function e(n){if(!this)return new e(n);var t,r,i,s,p,O,v,w,C,A=n&&n.proxy,y=x,k=m,q=!1,j=!1,E=null,M=!1;function N(e){e instanceof Error||(e=l(e)),E=e,y(e,k)}function P(e){p&&(e instanceof Error||(e=l(e)),p(e,k))}this.on=function(e,n){if("function"!=typeof n)throw l("required args <name, cb>");switch(e){case"openTag":r=n;break;case"text":t=n;break;case"closeTag":i=n;break;case"error":y=n;break;case"warn":p=n;break;case"cdata":s=n;break;case"attention":w=n;break;case"question":v=n;break;case"comment":O=n;break;default:throw l("unsupported event: "+e)}return this},this.ns=function(e){if(void 0===e&&(e={}),"object"!=typeof e)throw l("required args <nsMap={}>");var n,t={};for(n in e)t[n]=e[n];return t[o]=f,j=!0,C=t,this},this.parse=function(e){if("string"!=typeof e)throw l("required args <xml=string>");return E=null,function(e){var n,o,f,l,m,x,p,y,E,S,T=j?[]:null,_=j?function(e){var n,t,r={};for(n in e)r[t=e[n]]=t,r[h(t)]=n;return r}(C):null,D=[],I=0,L=!1,U=!1,X=0,$=0,z="",B=0;function F(){if(null!==S)return S;var e,n,t,r,i,s,o,f,c,l,g,m=j&&_.xmlns,x=j&&q?[]:null,p=B,O=z,v=O.length,w={},A={};e:for(;p<v;p++)if(c=!1,!(32===(l=O.charCodeAt(p))||l<14&&l>8)){for((l<65||l>122||l>90&&l<97)&&95!==l&&58!==l&&(P("illegal first char attribute name"),c=!0),g=p+1;g<v;g++)if(!((l=O.charCodeAt(g))>96&&l<123||l>64&&l<91||l>47&&l<59||46===l||45===l||95===l)){if(32===l||l<14&&l>8){P("missing attribute value"),p=g;continue e}if(61===l)break;P("illegal attribute name char"),c=!0}if("xmlns:xmlns"===(f=O.substring(p,g))&&(P("illegal declaration of xmlns"),c=!0),34===(l=O.charCodeAt(g+1)))-1===(g=O.indexOf('"',p=g+2))&&-1!==(g=O.indexOf("'",p))&&(P("attribute value quote missmatch"),c=!0);else if(39===l)-1===(g=O.indexOf("'",p=g+2))&&-1!==(g=O.indexOf('"',p))&&(P("attribute value quote missmatch"),c=!0);else for(P("missing attribute value quotes"),c=!0,g+=1;g<v&&!(32===(l=O.charCodeAt(g+1))||l<14&&l>8);g++);for(-1===g&&(P("missing closing quotes"),g=v,c=!0),c||(s=O.substring(p,g)),p=g;g+1<v&&!(32===(l=O.charCodeAt(g+1))||l<14&&l>8);g++)p===g&&(P("illegal character after attribute end"),c=!0);if(p=g+1,!c)if(f in A)P("attribute <"+f+"> already defined");else if(A[f]=!0,j)if(q){if(null!==(i="xmlns"===f?"xmlns":120===f.charCodeAt(0)&&"xmlns:"===f.substr(0,6)?f.substr(6):null)){if(e=u(s),n=h(i),!(o=C[e])){if("xmlns"===i||n in _&&_[n]!==e)do{o="ns"+I++}while(void 0!==_[o]);else o=i;C[e]=o}_[i]!==o&&(r||(_=b(_),r=!0),_[i]=o,"xmlns"===i&&(_[h(o)]=e,m=o),_[n]=e),w[f]=s;continue}x.push(f,s)}else-1!==(l=f.indexOf(":"))?(t=_[f.substring(0,l)])?((f=m===t?f.substr(l+1):t+f.substr(l))===a&&(-1!==(l=s.indexOf(":"))?(t=s.substring(0,l),t=_[t]||t,s=t+s.substring(l)):s=m+":"+s),w[f]=s):P(d(f.substring(0,l))):w[f]=s;else w[f]=s}if(q)for(p=0,v=x.length;p<v;p++){if(f=x[p++],s=x[p],-1!==(l=f.indexOf(":"))){if(!(t=_[f.substring(0,l)])){P(d(f.substring(0,l)));continue}(f=m===t?f.substr(l+1):t+f.substr(l))===a&&(-1!==(l=s.indexOf(":"))?(t=s.substring(0,l),t=_[t]||t,s=t+s.substring(l)):s=m+":"+s)}w[f]=s}return S=w}for(k=function(){for(var n,t,r=/(\r\n|\r|\n)/g,i=0,s=0,u=0,o=$;X>=u&&(n=r.exec(e))&&!((o=n[0].length+n.index)>X);)i+=1,u=o;return-1==X?(s=o,t=e.substring($)):0===$?(console.log(X-u),t=e.substring($,X)):(s=X-u,t=-1==$?e.substring(X):e.substring(X,$+1)),{data:t,line:i,column:s}},A&&(E=Object.create({},{name:g(function(){return p}),originalName:g(function(){return y}),attrs:g(F),ns:g(function(){return _})}));-1!==$;){if(-1===(X=60===e.charCodeAt($)?$:e.indexOf("<",$)))return D.length?N("unexpected end of file"):0===$?N("missing start tag"):void($<e.length&&e.substring($).trim()&&P(c));if($!==X)if(D.length){if(t&&(t(e.substring($,X),u,k),M))return}else if(e.substring($,X).trim()&&(P(c),M))return;if(33!==(m=e.charCodeAt(X+1)))if(63!==m){if(-1==($=e.indexOf(">",X+1)))return N("unclosed tag");if(S={},47===m){if(L=!1,U=!0,!D.length)return N("missing open tag");if(o=p=D.pop(),l=X+2+o.length,e.substring(X+2,l)!==o)return N("closing tag mismatch");for(;l<$;l++)if(!(32===(m=e.charCodeAt(l))||m>8&&m<14))return N("close tag")}else{if(47===e.charCodeAt($-1)?(o=p=e.substring(X+1,$-1),L=!0,U=!0):(o=p=e.substring(X+1,$),L=!0,U=!1),!(m>96&&m<123||m>64&&m<91||95===m||58===m))return N("illegal first char nodeName");for(l=1,f=o.length;l<f;l++)if(!((m=o.charCodeAt(l))>96&&m<123||m>64&&m<91||m>47&&m<59||45===m||95===m||46==m)){if(32===m||m<14&&m>8){p=o.substring(0,l),S=null;break}return N("invalid nodeName")}U||D.push(p)}if(j){if(n=_,L&&(U||T.push(n),null===S&&(q=-1!==o.indexOf("xmlns",l))&&(B=l,z=o,F(),q=!1)),y=p,-1!==(m=p.indexOf(":"))){if(!(x=_[p.substring(0,m)]))return N("missing namespace on <"+y+">");p=p.substr(m+1)}else x=_.xmlns;x&&(p=x+":"+p)}if(L&&(B=l,z=o,r&&(A?r(E,u,U,k):r(p,F,u,U,k),M)))return;if(U){if(i&&(i(A?E:p,u,L,k),M))return;j&&(_=L?n:T.pop())}$+=1}else{if(-1===($=e.indexOf("?>",X)))return N("unclosed question");if(v&&(v(e.substring(X,$+2),k),M))return;$+=2}else{if(91===(m=e.charCodeAt(X+2))&&"CDATA["===e.substr(X+3,6)){if(-1===($=e.indexOf("]]>",X)))return N("unclosed cdata");if(s&&(s(e.substring(X+9,$),k),M))return;$+=3;continue}if(45===m&&45===e.charCodeAt(X+3)){if(-1===($=e.indexOf("--\x3e",X)))return N("unclosed comment");if(O&&(O(e.substring(X+4,$),u,k),M))return;$+=3;continue}if(-1===($=e.indexOf(">",X+1)))return N("unclosed tag");if(w&&(w(e.substring(X,$+1),u,k),M))return;$+=1}}}(e),k=m,M=!1,E},this.stop=function(){M=!0}},e.decode=u,Object.defineProperty(e,"__esModule",{value:!0})});
